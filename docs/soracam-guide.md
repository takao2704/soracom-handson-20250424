# ソラカメ動画エクスポートガイド

このガイドでは、SORACOMのソラカメサービスを使用して、動画や静止画をエクスポートし、解析する方法を説明します。

## 前提条件

- SORACOMアカウントとAPIキー（setup-guide.mdを参照）
- Python 3.12以上と必要なライブラリ（setup-guide.mdを参照）
- ソラカメサービスの契約とカメラの設置

## 1.1 時刻を指定した動画の切り出し

ソラカメで録画された動画から、特定の時間範囲の動画をMP4形式でエクスポートする方法を説明します。

### APIの基本的な使い方

1. まず、`src/soracam/export_video.py`を開きます。
2. このスクリプトは、指定した時間範囲の動画をエクスポートするためのものです。

### 実行方法

1. 以下のコマンドを実行します：

```bash
# デバイスIDを指定して実行
python src/soracam/export_video.py --device_id YOUR_CAMERA_ID --start "2025-04-24T10:00:00" --end "2025-04-24T10:10:00" --output video.mp4
```

2. パラメータの説明：
   - `--device_id`: ソラカメのカメラID（必須）
   - `--start`: 開始時刻（ISO 8601形式）
   - `--end`: 終了時刻（ISO 8601形式）
   - `--output`: 出力ファイル名

### 動作の仕組み

1. ソラカメAPIを使用して認証を行います。
2. 指定されたカメラIDと時間範囲で動画エクスポートをリクエストします。
3. エクスポート処理が完了するまで待機します。
4. 完了したら、動画をダウンロードして指定されたファイルに保存します。

## 1.2 MPEG-DASHによるストリーミング映像の再生

ソラカメAPIを使用して、MPEG-DASH形式のストリーミングURLを取得し、ブラウザで再生する方法を説明します。

### ストリーミングURLの取得

1. 以下のコマンドを実行して、ストリーミングURLを取得します：

```bash
python src/soracam/get_streaming_url.py --device_id YOUR_CAMERA_ID
```

2. パラメータの説明：
   - `--device_id`: ソラカメのカメラID（必須）
   - `--from`: 録画映像の開始時刻（UNIX時間、ミリ秒）（オプション）
   - `--to`: 録画映像の終了時刻（UNIX時間、ミリ秒）（オプション）

3. 実行結果：
   - 成功すると、MPEG-DASH形式のストリーミングURL（.mpdファイル）が標準出力に表示されます。
   - このURLをコピーして、次のステップで使用します。

### ブラウザでの再生

1. 以下のHTMLファイルをブラウザで開きます：

```bash
open src/soracam/web/player.html
```

2. 表示されたフォームに、先ほど取得したストリーミングURLを貼り付けます。
3. 「再生」ボタンをクリックすると、MPEG-DASH形式のストリーミング映像が再生されます。

### プレーヤーの特徴

1. **SORACOMデザインシステム準拠**: SORACOMの公式デザインシステムに基づいたUI
2. **ダークモード対応**: システムの設定に応じて自動的にダークモードに切り替わります
3. **レスポンシブデザイン**: モバイルデバイスを含む様々な画面サイズに対応
4. **エラーハンドリング**: 再生中のエラーを検出して表示

### 動作の仕組み

1. `get_streaming_url.py`スクリプトは、ソラカメAPIを呼び出してストリーミングURLを取得します。
2. 取得したURLは標準出力に表示され、スクリプトは終了します。
3. `player.html`は、dash.jsライブラリを使用してMPEG-DASH形式のストリーミング映像を再生します。
4. URLにクエリパラメータが含まれていても正しく処理されます（`.mpd`を含むURLであれば有効）。

## 1.3 時刻を指定した静止画の切り出し

ソラカメで録画された映像から、特定の時刻の静止画をJPEG形式でエクスポートする方法を説明します。

### 実行方法

1. 以下のコマンドを実行します：

```bash
# デバイスIDを指定して実行
python src/soracam/export_image.py --device_id YOUR_CAMERA_ID --timestamp "2025-04-24T10:05:00" --output image.jpg
```

2. パラメータの説明：
   - `--device_id`: ソラカメのカメラID（必須）
   - `--timestamp`: 静止画を取得する時刻（ISO 8601形式）
   - `--output`: 出力ファイル名

### 動作の仕組み

1. ソラカメAPIを使用して認証を行います。
2. 指定されたカメラIDと時刻で静止画取得をリクエストします。
3. 取得した静止画をダウンロードして指定されたファイルに保存します。

## 1.4 切り出した静止画のYOLO解析 (+alpha)

YOLOモデル（デフォルト: yolov8n.pt）を使用して、静止画内の物体を検出する方法を説明します。

### 実行方法

1. 以下のコマンドを実行します：

```bash
# 画像を解析
python src/soracam/analyze_image_yolo.py --image image.jpg --output analyzed_image.jpg
```

2. パラメータの説明：
   - `--image`: 解析する画像ファイル（必須）
   - `--output`: 解析結果を保存するファイル名

### 動作の仕組み

1. YOLOモデル（デフォルト: yolov8n.pt）を読み込みます。
2. 指定された画像を読み込み、モデルに入力します。
3. 検出された物体にバウンディングボックスを描画します。
4. 結果を新しい画像ファイルとして保存します。

## 1.5 切り出した静止画の生成AIモデルによる解析 (+alpha)

OpenAI GPT-4oを使用して、静止画の内容を自然言語で解析する方法を説明します。

### 準備

1. OpenAI APIキーを取得します。
2. `.env`ファイルに以下の行を追加します：

```
OPENAI_API_KEY=あなたのOpenAI APIキー
```

3. 必要なパッケージをインストールします：

```bash
pip install -r requirements.txt
```

### 実行方法

1. 以下のコマンドを実行します：

```bash
python src/soracam/analyze_image_gpt.py --image image.jpg
```

2. パラメータの説明：
   - `--image`: 解析する画像ファイル

### 動作の仕組み

1. 指定された画像を読み込みます。
2. OpenAI APIを使用して、GPT-4oモデルに画像を送信します。
   - プロキシ設定を無効化して直接接続します。
   - 画像の詳細レベルを自動設定します。
3. モデルから返された解析結果（画像の説明）を表示します。

## 応用例

### 複数時刻の静止画一括取得

```bash
python src/soracam/export_image.py --device_id YOUR_CAMERA_ID --timestamps "2025-04-24T10:00:00,2025-04-24T11:00:00,2025-04-24T12:00:00" --output "image_%d.jpg"
```

### タイムラプス動画の作成

```bash
# 1時間ごとの静止画を24枚取得
python src/soracam/export_image.py --device_id YOUR_CAMERA_ID --start "2025-04-24T00:00:00" --end "2025-04-24T23:00:00" --interval 3600 --output "timelapse_%d.jpg"

# 静止画からタイムラプス動画を作成
python src/soracam/create_timelapse.py --input "timelapse_*.jpg" --output timelapse.mp4 --fps 5
```

## トラブルシューティング

### APIエラー

- APIキーが正しく設定されているか確認してください。
- カメラIDが正しいか確認してください。
- 指定した時間範囲に録画データが存在するか確認してください。

### 画像解析エラー

- YOLOモデル（ultralytics）がインストールされているか確認してください。
- OpenAI APIキーが正しく設定されているか確認してください。
- 画像ファイルが正しく指定されているか確認してください。

### その他のエラー

- インターネット接続を確認してください。
- Pythonの依存ライブラリが正しくインストールされているか確認してください。
  ```bash
  pip install -r requirements.txt
  ```